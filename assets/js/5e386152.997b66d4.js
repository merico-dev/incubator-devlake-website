"use strict";(self.webpackChunkwww=self.webpackChunkwww||[]).push([[6482],{3905:function(e,n,r){r.d(n,{Zo:function(){return c},kt:function(){return p}});var t=r(7294);function a(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function o(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,t)}return r}function l(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?o(Object(r),!0).forEach((function(n){a(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function i(e,n){if(null==e)return{};var r,t,a=function(e,n){if(null==e)return{};var r,t,a={},o=Object.keys(e);for(t=0;t<o.length;t++)r=o[t],n.indexOf(r)>=0||(a[r]=e[r]);return a}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(t=0;t<o.length;t++)r=o[t],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var s=t.createContext({}),u=function(e){var n=t.useContext(s),r=n;return e&&(r="function"==typeof e?e(n):l(l({},n),e)),r},c=function(e){var n=u(e.components);return t.createElement(s.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},m=t.forwardRef((function(e,n){var r=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),m=u(r),p=a,g=m["".concat(s,".").concat(p)]||m[p]||d[p]||o;return r?t.createElement(g,l(l({ref:n},c),{},{components:r})):t.createElement(g,l({ref:n},c))}));function p(e,n){var r=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var o=r.length,l=new Array(o);l[0]=m;var i={};for(var s in n)hasOwnProperty.call(n,s)&&(i[s]=n[s]);i.originalType=e,i.mdxType="string"==typeof e?e:a,l[1]=i;for(var u=2;u<o;u++)l[u]=r[u];return t.createElement.apply(null,l)}return t.createElement.apply(null,r)}m.displayName="MDXCreateElement"},4420:function(e,n,r){r.r(n),r.d(n,{assets:function(){return c},contentTitle:function(){return s},default:function(){return p},frontMatter:function(){return i},metadata:function(){return u},toc:function(){return d}});var t=r(7462),a=r(3366),o=(r(7294),r(3905)),l=["components"],i={title:"Dal",sidebar_position:5,description:"The Dal (Data Access Layer) is designed to decouple the hard dependency on `gorm` in v0.12\n"},s=void 0,u={unversionedId:"DeveloperManuals/Dal",id:"DeveloperManuals/Dal",title:"Dal",description:"The Dal (Data Access Layer) is designed to decouple the hard dependency on `gorm` in v0.12\n",source:"@site/docs/DeveloperManuals/Dal.md",sourceDirName:"DeveloperManuals",slug:"/DeveloperManuals/Dal",permalink:"/docs/DeveloperManuals/Dal",editUrl:"https://github.com/apache/incubator-devlake-website/edit/main/docs/DeveloperManuals/Dal.md",tags:[],version:"current",sidebarPosition:5,frontMatter:{title:"Dal",sidebar_position:5,description:"The Dal (Data Access Layer) is designed to decouple the hard dependency on `gorm` in v0.12\n"},sidebar:"docsSidebar",previous:{title:"Notifications",permalink:"/docs/DeveloperManuals/Notifications"},next:{title:"Tag Naming Conventions",permalink:"/docs/DeveloperManuals/TagNamingConventions"}},c={},d=[{value:"Summary",id:"summary",level:2},{value:"The Dal Interface",id:"the-dal-interface",level:2},{value:"How to use",id:"how-to-use",level:2},{value:"Query",id:"query",level:3},{value:"Insert",id:"insert",level:3},{value:"Update",id:"update",level:3},{value:"Insert or Update",id:"insert-or-update",level:3},{value:"Insert if record(by PrimaryKey) didn&#39;t exist",id:"insert-if-recordby-primarykey-didnt-exist",level:3},{value:"Delete",id:"delete",level:3},{value:"DDL and others",id:"ddl-and-others",level:3},{value:"How to do Unit Test",id:"how-to-do-unit-test",level:2}],m={toc:d};function p(e){var n=e.components,r=(0,a.Z)(e,l);return(0,o.kt)("wrapper",(0,t.Z)({},m,r,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"summary"},"Summary"),(0,o.kt)("p",null,"The Dal (Data Access Layer) is designed to decouple the hard dependency on ",(0,o.kt)("inlineCode",{parentName:"p"},"gorm")," in v0.12.  The advantages of introducing this isolation are:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Unit Test: Mocking an Interface is easier and more reliable than Patching a Pointer."),(0,o.kt)("li",{parentName:"ul"},"Clean Code: DBS operations are more consistence than using ",(0,o.kt)("inlineCode",{parentName:"li"},"gorm ")," directly."),(0,o.kt)("li",{parentName:"ul"},"Replaceable: It would be easier to replace ",(0,o.kt)("inlineCode",{parentName:"li"},"gorm")," in the future if needed.")),(0,o.kt)("h2",{id:"the-dal-interface"},"The Dal Interface"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},"type Dal interface {\n    AutoMigrate(entity interface{}, clauses ...Clause) error\n    Exec(query string, params ...interface{}) error\n    RawCursor(query string, params ...interface{}) (*sql.Rows, error)\n    Cursor(clauses ...Clause) (*sql.Rows, error)\n    Fetch(cursor *sql.Rows, dst interface{}) error\n    All(dst interface{}, clauses ...Clause) error\n    First(dst interface{}, clauses ...Clause) error\n    Count(clauses ...Clause) (int64, error)\n    Pluck(column string, dest interface{}, clauses ...Clause) error\n    Create(entity interface{}, clauses ...Clause) error\n    Update(entity interface{}, clauses ...Clause) error\n    CreateOrUpdate(entity interface{}, clauses ...Clause) error\n    CreateIfNotExist(entity interface{}, clauses ...Clause) error\n    Delete(entity interface{}, clauses ...Clause) error\n    AllTables() ([]string, error)\n}\n")),(0,o.kt)("h2",{id:"how-to-use"},"How to use"),(0,o.kt)("h3",{id:"query"},"Query"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'// Get a database cursor\nuser := &models.User{}\ncursor, err := db.Cursor(\n  dal.From(user),\n  dal.Where("department = ?", "R&D"),\n  dal.Orderby("id DESC"),\n)\nif err != nil {\n  return err\n}\nfor cursor.Next() {\n  err = dal.Fetch(cursor, user)  // fetch one record at a time\n  ...\n}\n\n// Get a database cursor by raw sql query\ncursor, err := db.Raw("SELECT * FROM users")\n\n// USE WITH CAUTIOUS: loading a big table at once is slow and dangerous\n// Load all records from database at once. \nusers := make([]models.Users, 0)\nerr := db.All(&users, dal.Where("department = ?", "R&D"))\n\n// Load a column as Scalar or Slice\nvar email string\nerr := db.Pluck("email", &username, dal.Where("id = ?", 1))\nvar emails []string\nerr := db.Pluck("email", &emails)\n\n// Execute query\nerr := db.Exec("UPDATE users SET department = ? WHERE department = ?", "Research & Development", "R&D")\n')),(0,o.kt)("h3",{id:"insert"},"Insert"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'err := db.Create(&models.User{\n  Email: "hello@example.com", // assumming this the Primarykey\n  Name: "hello",\n  Department: "R&D",\n})\n')),(0,o.kt)("h3",{id:"update"},"Update"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'err := db.Create(&models.User{\n  Email: "hello@example.com", // assumming this the Primarykey\n  Name: "hello",\n  Department: "R&D",\n})\n')),(0,o.kt)("h3",{id:"insert-or-update"},"Insert or Update"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'err := db.CreateOrUpdate(&models.User{\n  Email: "hello@example.com",  // assuming this is the Primarykey\n  Name: "hello",\n  Department: "R&D",\n})\n')),(0,o.kt)("h3",{id:"insert-if-recordby-primarykey-didnt-exist"},"Insert if record(by PrimaryKey) didn't exist"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'err := db.CreateIfNotExist(&models.User{\n  Email: "hello@example.com",  // assuming this is the Primarykey\n  Name: "hello",\n  Department: "R&D",\n})\n')),(0,o.kt)("h3",{id:"delete"},"Delete"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'err := db.CreateIfNotExist(&models.User{\n  Email: "hello@example.com",  // assuming this is the Primary key\n})\n')),(0,o.kt)("h3",{id:"ddl-and-others"},"DDL and others"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},"// Returns all table names\nallTables, err := db.AllTables()\n\n// Automigrate: create/add missing table/columns\n// Note: it won't delete any existing columns, nor does it update the column definition\nerr := db.AutoMigrate(&models.User{})\n")),(0,o.kt)("h2",{id:"how-to-do-unit-test"},"How to do Unit Test"),(0,o.kt)("p",null,"First, run the command ",(0,o.kt)("inlineCode",{parentName:"p"},"make mock")," to generate the Mocking Stubs, the generated source files should appear in ",(0,o.kt)("inlineCode",{parentName:"p"},"mocks")," folder. "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"mocks\n\u251c\u2500\u2500 ApiResourceHandler.go\n\u251c\u2500\u2500 AsyncResponseHandler.go\n\u251c\u2500\u2500 BasicRes.go\n\u251c\u2500\u2500 CloseablePluginTask.go\n\u251c\u2500\u2500 ConfigGetter.go\n\u251c\u2500\u2500 Dal.go\n\u251c\u2500\u2500 DataConvertHandler.go\n\u251c\u2500\u2500 ExecContext.go\n\u251c\u2500\u2500 InjectConfigGetter.go\n\u251c\u2500\u2500 InjectLogger.go\n\u251c\u2500\u2500 Iterator.go\n\u251c\u2500\u2500 Logger.go\n\u251c\u2500\u2500 Migratable.go\n\u251c\u2500\u2500 PluginApi.go\n\u251c\u2500\u2500 PluginBlueprintV100.go\n\u251c\u2500\u2500 PluginInit.go\n\u251c\u2500\u2500 PluginMeta.go\n\u251c\u2500\u2500 PluginTask.go\n\u251c\u2500\u2500 RateLimitedApiClient.go\n\u251c\u2500\u2500 SubTaskContext.go\n\u251c\u2500\u2500 SubTaskEntryPoint.go\n\u251c\u2500\u2500 SubTask.go\n\u2514\u2500\u2500 TaskContext.go\n")),(0,o.kt)("p",null,"With these Mocking stubs, you may start writing your TestCases using the ",(0,o.kt)("inlineCode",{parentName:"p"},"mocks.Dal"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'import "github.com/apache/incubator-devlake/mocks"\n\nfunc TestCreateUser(t *testing.T) {\n    mockDal := new(mocks.Dal)\n    mockDal.On("Create", mock.Anything, mock.Anything).Return(nil).Once()\n    userService := &services.UserService{\n        Dal: mockDal,\n    }\n    userService.Post(map[string]interface{}{\n        "email": "helle@example.com",\n        "name": "hello",\n        "department": "R&D",\n    })\n    mockDal.AssertExpectations(t)\n')))}p.isMDXComponent=!0}}]);