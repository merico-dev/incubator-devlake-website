"use strict";(self.webpackChunkwww=self.webpackChunkwww||[]).push([[8291],{3905:(e,n,t)=>{t.d(n,{Zo:()=>c,kt:()=>m});var i=t(67294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,i,a=function(e,n){if(null==e)return{};var t,i,a={},o=Object.keys(e);for(i=0;i<o.length;i++)t=o[i],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(i=0;i<o.length;i++)t=o[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var r=i.createContext({}),p=function(e){var n=i.useContext(r),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},c=function(e){var n=p(e.components);return i.createElement(r.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},d=i.forwardRef((function(e,n){var t=e.components,a=e.mdxType,o=e.originalType,r=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),d=p(t),m=a,h=d["".concat(r,".").concat(m)]||d[m]||u[m]||o;return t?i.createElement(h,s(s({ref:n},c),{},{components:t})):i.createElement(h,s({ref:n},c))}));function m(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var o=t.length,s=new Array(o);s[0]=d;var l={};for(var r in n)hasOwnProperty.call(n,r)&&(l[r]=n[r]);l.originalType=e,l.mdxType="string"==typeof e?e:a,s[1]=l;for(var p=2;p<o;p++)s[p]=t[p];return i.createElement.apply(null,s)}return i.createElement.apply(null,t)}d.displayName="MDXCreateElement"},20921:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>r,contentTitle:()=>s,default:()=>u,frontMatter:()=>o,metadata:()=>l,toc:()=>p});var i=t(87462),a=(t(67294),t(3905));const o={title:"Webhook",description:"Webhook Plugin\n"},s=void 0,l={unversionedId:"Plugins/webhook",id:"Plugins/webhook",title:"Webhook",description:"Webhook Plugin\n",source:"@site/docs/Plugins/webhook.md",sourceDirName:"Plugins",slug:"/Plugins/webhook",permalink:"/zh/docs/Plugins/webhook",draft:!1,editUrl:"https://github.com/apache/incubator-devlake-website/edit/main/docs/Plugins/webhook.md",tags:[],version:"current",frontMatter:{title:"Webhook",description:"Webhook Plugin\n"},sidebar:"docsSidebar",previous:{title:"Tapd",permalink:"/zh/docs/Plugins/tapd"},next:{title:"Live Demo",permalink:"/zh/docs/LiveDemo"}},r={},p=[{value:"Summary",id:"summary",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Incident / Issue",id:"incident--issue",level:2},{value:"Update or Create Issues",id:"update-or-create-issues",level:4},{value:"Close Issues (Optional)",id:"close-issues-optional",level:4},{value:"Sample API Calls",id:"sample-api-calls",level:3},{value:"Deployments",id:"deployments",level:2},{value:"Update or Create Tasks in the Pipeline",id:"update-or-create-tasks-in-the-pipeline",level:4},{value:"Close Pipelines",id:"close-pipelines",level:4},{value:"Sample API Calls",id:"sample-api-calls-1",level:3},{value:"Sample Config in CircleCi",id:"sample-config-in-circleci",level:3}],c={toc:p};function u(e){let{components:n,...t}=e;return(0,a.kt)("wrapper",(0,i.Z)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"summary"},"Summary"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Webhook"},"Webhooks")," are user-defined HTTP callbacks that can be used for causing an event on one site that will trigger certain behavior on another site. They can be triggered in your deployment and bug recording systems, such as build shells in Jenkins or Jira. "),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://user-images.githubusercontent.com/3294100/191303047-b66ece00-5095-420e-b52a-b61146de0d43.png",alt:"webhook"}),"\n(Image from the Internet)"),(0,a.kt)("p",null,"While using webhooks in DevLake, your systems play the roles of system A as shown in the above image, and Apache DevLake as system B. You can use webhooks to:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"record bugs or incidents when DevLake cannot collect data from issue applications directly."),(0,a.kt)("li",{parentName:"ul"},"detect code deployments by using custom deploy-time measurement ")),(0,a.kt)("p",null,"DevLake does not limit the number of webhook requests. ",(0,a.kt)("strong",{parentName:"p"},"But be aware")," that your Database or other servers may not handle unlimited requests."),(0,a.kt)("h2",{id:"configuration"},"Configuration"),(0,a.kt)("p",null,"Configuring webhooks via the Config UI."),(0,a.kt)("p",null,"First, you can create a webhook connection from the Integration page.\n",(0,a.kt)("img",{parentName:"p",src:"https://user-images.githubusercontent.com/3294100/191309840-460fbc9c-15a1-4b12-a510-9ed5ccd8f2b0.png",alt:"image"})),(0,a.kt)("p",null,"We recommand that you give your webhook connection a unique name so that you can identify and manage where you have used it later."),(0,a.kt)("p",null,'After cicking on "Generate POST URL", you will find four webhook URLs. Copy the ones that suits your usage into your CI or issue tracking systems. You can always come back to the webhook page to copy the URLs later on.'),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://user-images.githubusercontent.com/3294100/191400110-327c153f-b236-47e3-88cc-85bf8fcae310.png",alt:"image"})),(0,a.kt)("h2",{id:"incident--issue"},"Incident / Issue"),(0,a.kt)("p",null,"If you want to collect issue or incident data from your system, you can use the two webhooks for issues. "),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Notice"),": The URL shown in the screenshot and the following samples, ",(0,a.kt)("inlineCode",{parentName:"p"},"https://sample-url.com/..."),", is just an example and should be replaced with the actual URL copied from your Config UI."),(0,a.kt)("h4",{id:"update-or-create-issues"},"Update or Create Issues"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"POST https://sample-url.com/api/plugins/webhook/1/issues")),(0,a.kt)("p",null,"needs to be called when an issue or incident is created. The body includes columns as follows:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"board_key: issue belongs to which board/project\nurl(Optional):  issue's URL\nissue_key: issue's key, needs to be unique in a connection\ntitle\ndescription(Optional)\nepic_key(Optional): in which epic.\ntype(Optional): type, such as bug/incident/epic/...\nstatus: issue's status. Must be one of TODO DONE IN_PROGRESS\noriginal_status:  status in your system, such as created/open/closed/...\nstory_point(Optional)\nresolution_date(Optional): date, Format should be 2020-01-01T12:00:00+00:00\ncreated_date: date, Format should be 2020-01-01T12:00:00+00:00\nupdated_date(Optional): date, Format should be 2020-01-01T12:00:00+00:00\nlead_time_minutes(Optional): how long from this issue accepted to develop\nparent_issue_key(Optional)\npriority(Optional)\noriginal_estimate_minutes(Optional)\ntime_spent_minutes(Optional)\ntime_remaining_minutes(Optional)\ncreator_id(Optional): the user id of the creator\ncreator_name(Optional): the user name of the creator, it will just be used to display\nassignee_id(Optional)\nassignee_name(Optional)\nseverity(Optional)\ncomponent(Optional): which component is this issue in.\n")),(0,a.kt)("h4",{id:"close-issues-optional"},"Close Issues (Optional)"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"POST https://sample-url.com/api/plugins/webhook/1/issue/:boardKey/:issueId/close")),(0,a.kt)("p",null,"needs to be called when an issue or incident is closed. Replace ",(0,a.kt)("inlineCode",{parentName:"p"},":boardKey")," and ",(0,a.kt)("inlineCode",{parentName:"p"},":issueId")," with specific strings and keep the body empty."),(0,a.kt)("h3",{id:"sample-api-calls"},"Sample API Calls"),(0,a.kt)("p",null,"Sample CURL for Issue Creating :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'curl http://127.0.0.1:4000/api/plugins/webhook/1/issues -X \'POST\' -d \'{"board_key":"DLK","url":"","issue_key":"DLK-1234","title":"a feature from DLK","description":"","epic_key":"","type":"BUG","status":"TODO","original_status":"created","story_point":0,"resolution_date":null,"created_date":"2020-01-01T12:00:00+00:00","updated_date":null,"lead_time_minutes":0,"parent_issue_key":"DLK-1200","priority":"","original_estimate_minutes":0,"time_spent_minutes":0,"time_remaining_minutes":0,"creator_id":"user1131","creator_name":"Nick name 1","assignee_id":"user1132","assignee_name":"Nick name 2","severity":"","component":""}\'\n')),(0,a.kt)("p",null,"Sample CURL for Issue Closing:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"curl http://127.0.0.1:4000/api/plugins/webhook/1/issue/DLK/DLK-1234/close -X 'POST'\n")),(0,a.kt)("p",null,"Read more in Swagger: http://localhost:4000/api/swagger/index.html#/plugins%2Fwebhook/post_plugins_webhook__connectionId_issues. "),(0,a.kt)("h2",{id:"deployments"},"Deployments"),(0,a.kt)("p",null,"Adding pipeline webhook in your deploy shells will help you collect data into DevLake."),(0,a.kt)("p",null,"First, let us know there are two entities: Tasks and Pipelines. A pipeline means one build or deployment, and a pipeline may have more than one task."),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://user-images.githubusercontent.com/3294100/191319143-ea5e9546-1c6d-4b2a-abba-95375cfdcec3.png",alt:"image"})),(0,a.kt)("p",null,"(Example 1)"),(0,a.kt)("p",null,"For example, we can find 6 tasks like ",(0,a.kt)("inlineCode",{parentName:"p"},"golangci-lint")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"unit-test")," in one GitHub pipeline."),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://user-images.githubusercontent.com/3294100/191319924-f05c4790-d368-4fe4-8c07-dea43e1dd2f3.png",alt:"image"})),(0,a.kt)("p",null,"(Example 2. Image from the Internet)"),(0,a.kt)("p",null,"In Example 2, we can find 12 Jenkins pipelines."),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://user-images.githubusercontent.com/3294100/191320316-19e5a88f-550d-4460-b631-da634436e6e0.png",alt:"image"})),(0,a.kt)("p",null,"(Example 3. Image from the Internet)"),(0,a.kt)("p",null,"In Example 3, we can find 5 Jenkins pipelines, and these pipelines have 1~4 task(s)."),(0,a.kt)("p",null,"After figuring out ",(0,a.kt)("inlineCode",{parentName:"p"},"pipeline")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"task"),", we can start to add webhooks. Two hooks need to be added in shells. ",(0,a.kt)("strong",{parentName:"p"},"Notice"),": The URL shown in the following samples, ",(0,a.kt)("inlineCode",{parentName:"p"},"https://sample-url.com/..."),", should be replaced with the actual URL copied from your Config UI."),(0,a.kt)("h4",{id:"update-or-create-tasks-in-the-pipeline"},"Update or Create Tasks in the Pipeline"),(0,a.kt)("p",null,"This hook should be added when the task starts and finishes. So in Example 3, we need to add 8 CURLs in the 4 tasks."),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"POST https://sample-url.com/api/plugins/webhook/1/cicd_tasks")),(0,a.kt)("p",null,"The body should be a JSON and include columns as follows:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"pipeline_name: pipeline's name can be filled by any string unique in a connection\nname: task's name should be unique in one pipeline\nresult: Must be one of SUCCESS FAILURE ABORT IN_PROGRESS\nstatus: Must be one of IN_PROGRESS DONE\ntype: one of TEST LINT BUILD DEPLOYMENT\nenvironment: which type of machine did this task run in. one of PRODUCTION STAGING TESTING\nstarted_date: date, Format should be 2020-01-01T12:00:00+00:00\nfinished_date(Optional): date, Format should be 2020-01-01T12:00:00+00:00\nrepo_id: build for which repo/project. It can be a unique string that you can distinguish\nbranch(Optional)\ncommit_sha(Optional)\n")),(0,a.kt)("h4",{id:"close-pipelines"},"Close Pipelines"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"POST https://sample-url.com/api/plugins/webhook/1/cicd_pipeline/:pipelineName/finish")),(0,a.kt)("p",null,"This hook should be called to tell DevLake a pipeline finish when a pipeline is completed. ",(0,a.kt)("inlineCode",{parentName:"p"},":pipelineName")," need to be replaced with the pipeline name in the previous webhook."),(0,a.kt)("h3",{id:"sample-api-calls-1"},"Sample API Calls"),(0,a.kt)("p",null,"Sample CURL for the tasks starting and finishing in deploy pipelines:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'curl http://127.0.0.1:4000/api/plugins/webhook/1/cicd_tasks -X \'POST\' -d \'{"pipeline_name":"A123","name":"unit-test","result":"IN_PROGRESS","status":"IN_PROGRESS","type":"TEST","environment":"PRODUCTION","created_date":"2020-01-01T12:00:00+00:00","finished_date":"2020-01-01T12:59:59+00:00","repo_id":"devlake","branch":"main","commit_sha":"015e3d3b480e417aede5a1293bd61de9b0fd051d"}\'\n')),(0,a.kt)("p",null,"Sample CURL for pipeline completed:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"curl http://127.0.0.1:4000/api/plugins/webhook/1/cicd_pipeline/A123/finish -X 'POST' -d ''\n")),(0,a.kt)("p",null,"Read more in Swagger: http://localhost:4000/api/swagger/index.html#/plugins%2Fwebhook/post_plugins_webhook__connectionId_issues. "),(0,a.kt)("h3",{id:"sample-config-in-circleci"},"Sample Config in CircleCi"),(0,a.kt)("p",null,"First, we need to know that CircleCi has three entities: pipeline, workflow, and job, and the entity workflow is the entity task in DevLake.\nSecond, we must get pipelines and task data from the build machine. In CircleCi, the data define in env, and we can get it by $CIRCLE_WORKFLOW_JOB_ID and so on. So we can write config to send task data in each workflow and send the close pipeline request in the last workflow."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},'version: 2.1\n\njobs:\n  build:\n    docker:\n      - image: cimg/base:stable\n    steps:\n      - checkout\n      - run:\n          name: "build"\n          command: |\n            create_time=`date \'+%Y-%m-%dT%H:%M:%S%z\'`\n            echo Hello, World!\n            curl https://sample-url.com/api/plugins/webhook/1/cicd_tasks -X \'POST\' -d "{\\"pipeline_name\\":\\"`date \'+%Y-%m-%d\'`$CIRCLE_SHA1\\",\\"name\\":\\"$CIRCLE_WORKFLOW_JOB_ID\\",\\"result\\":\\"SUCCESS\\",\\"status\\":\\"DONE\\",\\"type\\":\\"BUILD\\",\\"environment\\":\\"PRODUCTION\\",\\"created_date\\":\\"$create_time\\",\\"finished_date\\":\\"`date \'+%Y-%m-%dT%H:%M:%S%z\'`\\",\\"repo_id\\":\\"$CIRCLE_REPOSITORY_URL\\",\\"branch\\":\\"$CIRCLE_BRANCH\\",\\"commit_sha\\":\\"$CIRCLE_SHA1\\"}"\n\n  deploy:\n    docker:\n      - image: cimg/base:stable\n    steps:\n      - checkout\n      - run:\n          name: "deploy"\n          command: |\n            create_time=`date \'+%Y-%m-%dT%H:%M:%S%z\'`\n            echo Hello, World!\n            curl https://sample-url.com/api/plugins/webhook/1/cicd_tasks -X \'POST\' -d "{\\"pipeline_name\\":\\"`date \'+%Y-%m-%d\'`$CIRCLE_SHA1\\",\\"name\\":\\"$CIRCLE_WORKFLOW_JOB_ID\\",\\"result\\":\\"SUCCESS\\",\\"status\\":\\"DONE\\",\\"type\\":\\"DEPLOYMENT\\",\\"environment\\":\\"PRODUCTION\\",\\"created_date\\":\\"$create_time\\",\\"finished_date\\":\\"`date \'+%Y-%m-%dT%H:%M:%S%z\'`\\",\\"repo_id\\":\\"$CIRCLE_REPOSITORY_URL\\",\\"branch\\":\\"$CIRCLE_BRANCH\\",\\"commit_sha\\":\\"$CIRCLE_SHA1\\"}"\n      - run:\n          name: "close pipeline"\n          command: |\n            env\n            curl https://sample-url.com/api/plugins/webhook/1/cicd_pipeline/`date \'+%Y-%m-%d\'`$CIRCLE_SHA1/finish -X \'POST\' -d \'\'\n          when: always\n\nworkflows:\n  say-hello-workflow:\n    jobs:\n      - build\n      - deploy\n')),(0,a.kt)("p",null,"Actually, we finish the webhook in prev step. If we want to do more, the config in CircleCi is as fellow. It will call webhook before tasks start and after tasks fail."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},'# Use the latest 2.1 version of CircleCI pipeline process engine.\n# See: https://circleci.com/docs/2.0/configuration-reference\nversion: 2.1\n\n# Define a job to be invoked later in a workflow.\n# See: https://circleci.com/docs/2.0/configuration-reference/#jobs\njobs:\n  build:\n    # Specify the execution environment. You can specify an image from Dockerhub or use one of our Convenience Images from CircleCI\'s Developer Hub.\n    # See: https://circleci.com/docs/2.0/configuration-reference/#docker-machine-macos-windows-executor\n    docker:\n      - image: cimg/base:stable\n    # Add steps to the job\n    # See: https://circleci.com/docs/2.0/configuration-reference/#steps\n    steps:\n      - checkout\n      - run:\n          name: "build"\n          command: |\n            create_time=`date \'+%Y-%m-%dT%H:%M:%S%z\'`\n            curl https://sample-url.com/api/plugins/webhook/1/cicd_tasks -X \'POST\' -d "{\u2026\u2026\\"result\\":\\"IN_PROGRESS\\",\\"status\\":\\"IN_PROGRESS\\"\u2026\u2026}"\n            echo Hello, World!\n            sleep $[ ( $RANDOM % 10 )  + 1 ]\n            curl https://sample-url.com/api/plugins/webhook/1/cicd_tasks -X \'POST\' -d "{\\"result\\":\\"SUCCESS\\",\\"status\\":\\"DONE\\",\u2026\u2026}"\n      - run:\n          name: "send fail"\n          command: |\n            curl https://sample-url.com/api/plugins/webhook/1/cicd_tasks -X \'POST\' -d "{\\"result\\":\\"FAILURE\\",\\"status\\":\\"DONE\\"\u2026\u2026}"\n          when: on_fail\n\n  deploy:\n    docker:\n      - image: cimg/base:stable\n    steps:\n      - checkout\n      - run:\n          name: "deploy"\n          command: |\n          \u2026\u2026 # the same as before\n      - run:\n          name: "send fail"\n          command: |\n          \u2026\u2026 # the same as before\n          when: on_fail \n      - run:\n          name: "close pipeline"\n          command: |\n            env\n            curl https://sample-url.com/api/plugins/webhook/1/cicd_pipeline/`date \'+%Y-%m-%d\'`$CIRCLE_SHA1/finish -X \'POST\' -d \'\'\n          when: always\n\n# Invoke jobs via workflows\n# See: https://circleci.com/docs/2.0/configuration-reference/#workflows\nworkflows:\n  say-hello-workflow:\n    jobs:\n      - build\n      - deploy\n')))}u.isMDXComponent=!0}}]);